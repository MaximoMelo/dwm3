<!DOCTYPE html>
<html lang="es">
<head>
    <title>Boleta Electrónica</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        :root {
            --primary-bg: #1e3a8a;
            --light-bg: #ffffff;
            --card-bg: #ffffff;
            --dark-border: #dddddd;
            --text-dark: #212529;
            --primary-color: #3498db;
            --primary-hover: #5dade2;
            --secondary-color: #6c757d;
            --danger-color: #cc4c4c;
            --border-radius-lg: 12px; 
            --border-radius-sm: 6px;  
        }

        body {
            background-color: var(--light-bg);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--text-dark);
        }

        .main-card {
            max-width: 450px; 
            width: 95%;
            padding: 30px;
            border-radius: var(--border-radius-lg);
            background-color: var(--card-bg) !important;
            color: var(--text-dark) !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); 
            border: 1px solid var(--dark-border);
        }
        
        .divider {
            border: none;
            border-top: 1px solid var(--dark-border);
            margin: 10px 0; 
        }

        .data-row {
            display: flex;
            justify-content: space-between; 
            margin-bottom: 5px; 
            font-size: 1.05em;
            color: var(--text-dark); 
        }

        .data-label {
            font-weight: bold;
        }

        .form-control-readonly {
            background-color: #f8f8f8 !important; 
            color: var(--text-dark) !important;
            border: 1px solid var(--dark-border) !important;
            padding: 0.375rem 0.5rem; 
            height: auto;
            width: 100%;
            font-size: 1rem;
            line-height: 1.5;
            resize: none; 
            border-radius: var(--border-radius-sm);
        }
        
        .input-container {
            width: 60%;
            text-align: right;
        }

        .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
            color: var(--light-bg) !important;
            transition: background-color 0.3s, box-shadow 0.3s;
            border-radius: var(--border-radius-sm); 
        }
        .btn-primary:hover {
            background-color: var(--primary-hover) !important;
            border-color: var(--primary-hover) !important;
            box-shadow: 0 2px 10px rgba(52, 152, 219, 0.6);
        }
    </style>
</head>
<body class="d-flex align-items-center justify-content-center vh-100">
    
    <div class="main-card">
        
        <h5 class="text-center mb-4" style="color: var(--primary-color);">Boleta Electrónica</h5>
        <hr class="divider">
        
        <div class="data-row">
            <span class="data-label">Nombre:</span>
            <span class="input-container">
                <input type="text" class="form-control-readonly text-end" readonly id="boleta-nombre">
            </span>
        </div>
        
        <div class="data-row">
            <span class="data-label">Dirección:</span>
            <span class="input-container">
                <input type="text" class="form-control-readonly text-end" readonly id="boleta-direccion">
            </span>
        </div>
        
        <div class="data-row">
            <span class="data-label">Email:</span>
            <span class="input-container">
                <input type="text" class="form-control-readonly text-end" readonly id="boleta-email">
            </span>
        </div>
        
        <div class="data-row mb-4">
            <span class="data-label">Fecha de emisión:</span>
            <span class="input-container">
                <input type="text" class="form-control-readonly text-end" readonly id="boleta-fecha">
            </span>
        </div>
        
        <hr class="divider">

        <p class="fw-bold mb-2">Detalles de venta:</p>

        <div class="data-row">
            <textarea class="form-control-readonly" rows="5" readonly id="boleta-detalles" style="width: 100%;"></textarea>
        </div>

        <hr class="divider">
        
        <div class="data-row">
            <span class="data-label">Medio de pago:</span>
            <span class="input-container">
                <input type="text" class="form-control-readonly text-end" readonly id="boleta-medio-pago">
            </span>
        </div>

        <div class="data-row fw-bold fs-5 mt-3 align-items-center">
            <span class="data-label" style="color: var(--primary-color);">TOTAL PAGADO:</span>
            <span class="input-container">
                <input type="text" class="form-control-readonly fw-bold text-end" readonly id="boleta-total" style="font-size: 1.2em; border: 2px solid var(--primary-color) !important;">
            </span>
        </div>
        
        <hr class="divider">
        
        <p class="text-center mt-3" style="font-size:0.9em; color: var(--secondary-color);">¡Gracias por su compra!</p>
        
        <div class="mt-4">
            <a class="btn btn-primary w-100" href="index.html"> 
                Finalizar
            </a>
        </div>
        
    </div>

    <script>
        const formatCurrency = (number) => {
            return '$' + Math.round(number).toLocaleString('es-CL');
        };

        async function cargarDatosCliente() {
            const userEmail = localStorage.getItem('userEmail');
            
            if (!userEmail) {
                document.getElementById('boleta-nombre').value = 'Cliente no identificado';
                document.getElementById('boleta-email').value = 'No disponible';
                document.getElementById('boleta-direccion').value = 'No disponible';
                document.getElementById('boleta-medio-pago').value = 'No especificado';
                return;
            }
            
            try {
                const response = await fetch(`/api/usuarios/${userEmail}`);
                if (response.ok) {
                    const userData = await response.json();
                    
                    document.getElementById('boleta-nombre').value = userData.nombre || userEmail.split('@')[0];
                    document.getElementById('boleta-email').value = userData.email || userEmail;
                    document.getElementById('boleta-direccion').value = userData.direccion || 'Sin dirección registrada';
                    document.getElementById('boleta-medio-pago').value = userData.metodoPago || 'No especificado';
                } else {
                    setDefaultData(userEmail);
                }
            } catch (error) {
                console.error('Error cargando datos del cliente:', error);
                setDefaultData(userEmail);
            }
        }
        
        function setDefaultData(email) {
            document.getElementById('boleta-nombre').value = email.split('@')[0];
            document.getElementById('boleta-email').value = email;
            document.getElementById('boleta-direccion').value = 'Sin dirección registrada';
            document.getElementById('boleta-medio-pago').value = 'No especificado';
        }
        
        async function guardarPedidoEnHistorial() {
            try {
                const cart = JSON.parse(localStorage.getItem('shoppingCart')) || {};
                const userEmail = localStorage.getItem('userEmail');
                
                if (!userEmail || Object.keys(cart).length === 0) {
                    return;
                }
                
                const total = calcularTotal(cart);
                
                const pedidoData = {
                    usuarioEmail: userEmail,
                    productos: cart,
                    total: total
                };
                
                const response = await fetch('/api/pedidos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pedidoData)
                });
                
                if (response.ok) {
                    localStorage.removeItem('shoppingCart');
                }
            } catch (error) {
                console.error('Error guardando pedido:', error);
            }
        }
        
        function calcularTotal(cart) {
            return Object.values(cart).reduce((total, item) => {
                return total + (item.quantity * item.price);
            }, 0);
        }

        function cargarDetallesCompra() {
            const cart = JSON.parse(localStorage.getItem('shoppingCart')) || {};
            let total = 0;
            let detallesTexto = "";
            let contador = 1;

            const productIds = Object.keys(cart);

            if (productIds.length === 0) {
                detallesTexto = "El carrito estaba vacío al momento de la compra.";
            } else {
                productIds.forEach((productId) => {
                    const item = cart[productId];
                    const itemSubtotal = item.quantity * item.price;
                    total += itemSubtotal;
                    
                    detallesTexto += `${contador}. ${item.name} (x${item.quantity}) ${formatCurrency(itemSubtotal)}\n`;
                    contador++;
                });

                detallesTexto += `\nSubtotal de ítems: ${formatCurrency(total)}`;
            }
            
            document.getElementById('boleta-detalles').value = detallesTexto.trim();
            document.getElementById('boleta-total').value = formatCurrency(total);
            
            const date = new Date();
            const formattedDate = date.toLocaleDateString('es-CL');
            document.getElementById('boleta-fecha').value = formattedDate;
        }

        async function loadBoletaDetails() {
            await cargarDatosCliente();
            cargarDetallesCompra();
            await guardarPedidoEnHistorial();
        }

        window.onload = loadBoletaDetails;
    </script>
</body>
</html>